<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Manager Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-200 min-h-screen">
  <div class="max-w-2xl mx-auto py-10">
    <h1 class="text-3xl font-bold text-center text-purple-700 mb-8 flex items-center justify-center gap-2">
      <i class="fab fa-node-js text-green-600" title="Node.js"></i>
      Expense Manager
    </h1>
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div>
          <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="category" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
            <option value="food">ğŸ½ï¸ Food</option>
            <option value="vegetable">ğŸ¥¦ Vegetable</option>
            <option value="clothes">ğŸ‘• Clothes</option>
            <option value="beauty">ğŸ’„ Beauty</option>
            <option value="vehicles">ğŸš— Vehicles</option>
            <option value="daily">ğŸ›’ Daily Expense</option>
            <option value="other">ğŸ“¦ Other</option>
          </select>
        </div>
        <div>
          <label for="desc" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <input type="text" id="desc" placeholder="e.g. Dosa, Jeans, Lipstick" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
        </div>
        <div>
          <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (â‚¹)</label>
          <input type="number" id="amount" placeholder="Amount" required min="0" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
        </div>
        <div>
          <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
          <input type="date" id="date" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
        </div>
        <div class="flex items-end">
          <button type="submit" class="w-full bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700 transition">Add Expense</button>
        </div>
      </form>
    </div>
    <!-- Unified Dashboard and Table -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
          <h2 class="text-xl font-semibold text-purple-700 mb-2">Today's Expenses</h2>
          <span id="todayCount" class="text-3xl font-bold text-purple-700">0</span>
          <span class="text-gray-500 ml-2">items</span>
        </div>
        <div>
          <span class="font-semibold text-gray-600">Total Today:</span>
          <span id="todayTotal" class="text-2xl font-bold text-green-600 ml-2">â‚¹0</span>
        </div>
      </div>
      <h2 class="text-xl font-semibold text-gray-700 mb-4">All Expenses</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount (â‚¹)</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody id="expenseList" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <div class="mt-6 flex justify-between items-center">
        <span class="font-semibold text-gray-600">Total:</span>
        <span id="totalAmount" class="text-lg font-bold text-purple-700">â‚¹0</span>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Edit Expense</h3>
        <form id="editForm" class="flex flex-col gap-4">
          <select id="editCategory" required class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
            <option value="food">ğŸ½ï¸ Food</option>
            <option value="vegetable">ğŸ¥¦ Vegetable</option>
            <option value="clothes">ğŸ‘• Clothes</option>
            <option value="beauty">ğŸ’„ Beauty</option>
            <option value="vehicles">ğŸš— Vehicles</option>
            <option value="daily">ğŸ›’ Daily Expense</option>
            <option value="other">ğŸ“¦ Other</option>
          </select>
          <input type="text" id="editDesc" required class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
          <input type="number" id="editAmount" required min="0" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
          <input type="date" id="editDate" required class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
          <div class="flex justify-end gap-2">
            <button type="button" id="cancelEdit" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    const expenseForm = document.getElementById('expenseForm');
    const expenseList = document.getElementById('expenseList');
    const totalAmount = document.getElementById('totalAmount');
    const todayTotal = document.getElementById('todayTotal');
    const todayCount = document.getElementById('todayCount');

    // Helper to get today's date in yyyy-mm-dd
    function getToday() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }
    // Set default date to today
    document.getElementById('date').value = getToday();

    // Fetch and render expenses
    async function loadExpenses() {
      const res = await fetch('/api/expenses');
      const expenses = await res.json();
      renderExpenses(expenses);
      renderTodayDashboard(expenses);
    }

    // Render all expenses
    function renderExpenses(expenses) {
      expenseList.innerHTML = '';
      let total = 0;
      const categoryEmojis = {
        food: 'ğŸ½ï¸',
        vegetable: 'ğŸ¥¦',
        clothes: 'ğŸ‘•',
        beauty: 'ğŸ’„',
        vehicles: 'ğŸš—',
        daily: 'ğŸ›’',
        other: 'ğŸ“¦'
      };
      expenses.forEach(exp => {
        total += exp.amount;
        const tr = document.createElement('tr');
        const emoji = categoryEmojis[exp.category] || '';
     tr.innerHTML = `
  <td class="px-4 py-2">${exp.desc}</td>
  <td class="px-4 py-2">â‚¹${exp.amount}</td>
  <td class="px-4 py-2">${exp.date || ''}</td>
  <td class="px-4 py-2">${emoji} ${exp.category ? exp.category.charAt(0).toUpperCase() + exp.category.slice(1) : ''}</td>
  <td class="px-4 py-2">
    <button onclick="openEditModal('${exp._id}', '${exp.desc.replace(/'/g, "&#39;")}', ${exp.amount}, '${exp.date || ''}', '${exp.category || ''}')" class="text-blue-500 hover:underline mr-2">Edit</button>
    <button onclick="deleteExpense('${exp._id}')" class="text-red-500 hover:underline">Delete</button>
  </td>
`;
        expenseList.appendChild(tr);
      });
      totalAmount.textContent = `â‚¹${total}`;
    }

    // Render dashboard for today's expenses
    function renderTodayDashboard(expenses) {
      const today = getToday();
      const todays = expenses.filter(e => e.date === today);
      let total = 0;
      todays.forEach(e => total += e.amount);
      todayTotal.textContent = `â‚¹${total}`;
      todayCount.textContent = todays.length;
    }

    // Add expense
    expenseForm.onsubmit = async function(e) {
      e.preventDefault();
      const desc = document.getElementById('desc').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      let date = document.getElementById('date').value;
      const category = document.getElementById('category').value;
      if (!desc || isNaN(amount) || !category) return;
      if (!date) date = getToday();
      const payload = { desc, amount, date, category };
      console.log('Expense payload:', payload);
      const response = await fetch('/api/expenses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const responseData = await response.json();
      console.log('POST /api/expenses response:', responseData);
      expenseForm.reset();
      document.getElementById('date').value = getToday();
      loadExpenses();
    };

    // Delete expense
    window.deleteExpense = async function(id) {
      await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
      loadExpenses();
    };

    // Edit expense with modal
    let editingId = null;
    window.openEditModal = function(id, desc, amount, date, category) {
      editingId = id;
      document.getElementById('editDesc').value = desc;
      document.getElementById('editAmount').value = amount;
      // Always show the date in yyyy-mm-dd format
      let formattedDate = date;
      if (date && date.length > 10) {
        formattedDate = date.slice(0, 10);
      }
      document.getElementById('editDate').value = formattedDate || getToday();
      // Set category in modal
      document.getElementById('editCategory').value = category || 'other';
      document.getElementById('editModal').classList.remove('hidden');
    };
    document.getElementById('cancelEdit').onclick = function() {
      document.getElementById('editModal').classList.add('hidden');
    };
    document.getElementById('editForm').onsubmit = function(e) {
      e.preventDefault();
      const newDesc = document.getElementById('editDesc').value.trim();
      const newAmount = parseFloat(document.getElementById('editAmount').value);
      let newDate = document.getElementById('editDate').value;
      const newCategory = document.getElementById('editCategory').value;
      if (!newDesc || isNaN(newAmount) || !newCategory) return;
      if (!newDate) newDate = getToday();
      fetch(`/api/expenses/${editingId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ desc: newDesc, amount: newAmount, date: newDate, category: newCategory })
      }).then(() => {
        document.getElementById('editModal').classList.add('hidden');
        loadExpenses();
      });
    };

    // Initial load
    loadExpenses();
  </script>
</body>
</html>
